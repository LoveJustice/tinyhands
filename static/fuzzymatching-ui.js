// Generated by CoffeeScript 1.4.0
(function() {
  var $cur_input, display_results, pulse, search, setupInputHandlers;

  $cur_input = "";

  window.cur_row = "";

  setupInputHandlers = function($ui) {
    var $fuzzy_ui_eles;
    $fuzzy_ui_eles = $("[data-fuzzy-ui]");
    $(document).click(function(e) {
      var $btn;
      $btn = $(".popover").siblings("button.show-matches");
      return $btn.each(function(idx, ele) {
        if (e.target !== ele) {
          return $(ele).popover("hide");
        }
      });
    });
    return $("table#interceptees input, table#interceptees select").on("keyup change", function(e) {
      var $row, $this, _ref;
      if ((_ref = e.which) !== 9 && _ref !== 16 && _ref !== 17 && _ref !== 18 && _ref !== 37 && _ref !== 38 && _ref !== 39 && _ref !== 40) {
        $this = $(this);
        $row = $this.parents("tr");
        $row.find("[id*=person_id]").val("");
        return pulse($row.find("button.show-matches").addClass("pulse"));
      }
    });
  };

  pulse = function(ele) {
    return ele.addClass("pulse");
  };

  search = function(input, $ui, callback, $row) {
    if (input.length === 0) {
      return;
    }
    return $.get(window.fuzzy_ajax_url, {
      name: input
    }, function(data) {
      var results;
      if (data.success) {
        results = [];
        data.data.forEach(function(group) {
          var id, names, scores;
          names = group[1];
          scores = group[2];
          id = group[0];
          return $.each(names, function(idx) {
            return results.push({
              id: id,
              name: names[idx],
              score: scores[idx]
            });
          });
        });
        return callback(results, $ui);
      }
    });
  };

  display_results = function(results, $ui) {
    var $li, $span, $ul, item, _i, _len, _ref, _results;
    $ul = $ui.find("ul");
    $ul.children().remove();
    if (results.length > 0) {
      _ref = results.sort(function(a, b) {
        return b.score - a.score;
      });
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        $span = $("<span>").addClass("name").text(item.name);
        $li = $("<li class='person'>").attr("id", item.id).text("(" + item.score + ") ").append($span);
        _results.push($ul.append($li));
      }
      return _results;
    } else {
      $li = $("<li>").text("Type to search for matches");
      return $ul.append($li);
    }
  };

  $(function() {
    var $modal, $popover_button, $ui;
    $modal = $('#matching_modal');
    $ui = $("#fuzzymatching-ui");
    setupInputHandlers($ui);
    $(document.body).on("click", ".popover li.person", function() {
      var $row, $this, age, built_url, name, phone, url;
      $this = $(this);
      url = dutils.urls.resolve('matching_modal', {
        id: this.id
      });
      $row = $this.parents('tr');
      $row.find("button.show-matches").click();
      name = encodeURIComponent($row.find('[id$=name]').val());
      phone = encodeURIComponent($row.find('[id$=phone]').val());
      age = encodeURIComponent($row.find('[id$=age]').val());
      built_url = "" + url + "?name=" + name + "&phone=" + phone + "&age=" + age;
      return $modal.load(built_url, function() {
        $modal.modal();
        return init();
      });
    });
    $popover_button = $("button.show-matches");
    $popover_button.popover({
      content: $("#fuzzymatching-ui2").html(),
      html: true,
      animation: false,
      placement: "bottom",
      trigger: "click",
      template: '<div class="popover" role="tooltip" style="width: 300px"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'
    });
    $popover_button.on("show.bs.popover", function() {
      window.cur_row = $(this).parents("tr");
      return $(this).removeClass("pulse");
    });
    return $popover_button.on("shown.bs.popover", function() {
      var $popover, $row, $this;
      $this = $(this);
      $popover = $this.siblings(".popover").children(".popover-content");
      $row = $this.parents("tr");
      if ($row.find("[id$=name]").val().length > 0) {
        return search($row.find("[id$=name]").val(), $popover, display_results, $this.parents("tr"));
      }
    });
  });

}).call(this);
