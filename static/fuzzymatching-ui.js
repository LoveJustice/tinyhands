// Generated by CoffeeScript 1.4.0
(function() {
  var $cur_input, display_results, search, setupInputHandlers;

  $cur_input = "";

  setupInputHandlers = function($ui) {
    var $fuzzy_ui_eles;
    $fuzzy_ui_eles = $("[data-fuzzy-ui]");
    $fuzzy_ui_eles.focus(function() {
      var $this;
      $this = $(this);
      $cur_input = $this;
      $ui.css({
        top: $this.offset().top + $this.outerHeight() + 15,
        left: $this.offset().left
      });
      if ($this.val().length > 0) {
        search($this.val(), $ui);
      }
      $ui.find("img").attr("src", "").hide();
      return $ui.show();
    });
    $(document).click(function(e) {
      var $target;
      $target = $(e.target);
      if (!$target.attr("data-fuzzy-ui") && e.target.id !== 'fuzzymatching-ui' && $target.parents('#fuzzymatching-ui').length === 0) {
        return $ui.hide();
      }
    });
    return $fuzzy_ui_eles.keyup(function(e) {
      var _ref;
      if ((_ref = e.which) !== 16 && _ref !== 17 && _ref !== 18 && _ref !== 37 && _ref !== 38 && _ref !== 39 && _ref !== 40) {
        return search($(this).val(), $ui);
      }
    });
  };

  search = function(input, $ui) {
    return $.get($ui.data("ajax"), {
      name: input
    }, function(data) {
      var results;
      if (data.success) {
        results = [];
        data.data.forEach(function(group) {
          var id, names, photo, scores;
          names = group[1];
          scores = group[2];
          id = group[0];
          photo = group[3];
          return $.each(names, function(idx) {
            return results.push({
              id: id,
              name: names[idx],
              score: scores[idx],
              photo: photo
            });
          });
        });
        return display_results(results, $ui);
      }
    });
  };

  display_results = function(results, $ui) {
    var $li, $span, $ul, item, _i, _len, _ref, _results;
    $ul = $ui.find("ul");
    $ul.children().remove();
    if (results.length > 0) {
      _ref = results.sort(function(a, b) {
        return b.score - a.score;
      });
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        $span = $("<span>").addClass("name").text(item.name);
        $li = $("<li class='person'>").attr("id", item.id).text("(" + item.score + ")").data("photo", item.photo).append($span);
        _results.push($ul.append($li));
      }
      return _results;
    } else {
      $li = $("<li>").text("Type to search for matches");
      return $ul.append($li);
    }
  };

  $(function() {
    var $modal, $ui;
    $modal = $('#matching_modal');
    $ui = $("#fuzzymatching-ui");
    setupInputHandlers($ui);
    $ui.on("click", "li.person", function() {
      var $row, $this, age, built_url, name, phone, url;
      $this = $(this);
      url = dutils.urls.resolve('matching_modal', {
        id: this.id
      });
      $row = $cur_input.parents('tr');
      name = $row.find('#fuzzy_name').val();
      phone = $row.find('#fuzzy_phone_contact').val();
      age = $row.find('#fuzzy_age').val();
      built_url = "" + url + "?name=" + name + "&phone=" + phone + "&age=" + age;
      console.log(built_url);
      return $modal.load(built_url, function() {
        return $modal.modal();
      });
    });
    return $ui.on("mouseover", "li.person", function() {
      return $ui.find("img").attr("src", "" + ($(this).data("photo"))).show();
    });
  });

}).call(this);
